name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Specific version to release (e.g. 1.2.3, 1.2.3-beta.1, 1.2.3-rc.1), or leave empty for auto-detect from conventional commits"
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    outputs:
      version: ${{ steps.release_meta.outputs.version }}
      prerelease: ${{ steps.release_meta.outputs.prerelease }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine next version (auto)
        if: inputs.version == ''
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ github.token }}
          noVersionBumpBehavior: patch
          noNewCommitBehavior: patch

      - name: Validate manual version
        if: inputs.version != ''
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$'; then
            echo "::error::Invalid version format '${{ inputs.version }}'. Expected X.Y.Z, X.Y.Z-beta.N, or X.Y.Z-rc.N"
            exit 1
          fi

      - name: Set release metadata
        id: release_meta
        env:
          VERSION: ${{ inputs.version != '' && inputs.version || steps.semver.outputs.nextStrict }}
        run: |
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-(beta|rc)\.[0-9]+$'; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create tag
        env:
          VERSION: ${{ steps.release_meta.outputs.version }}
        run: |
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Generate release notes
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ github.token }}
          tag: ${{ steps.release_meta.outputs.version }}
          writeToFile: false
          useGitmojis: false
          excludeTypes: ""
          includeInvalidCommits: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.version }}
          body: ${{ steps.changelog.outputs.changes }}
          prerelease: ${{ steps.release_meta.outputs.prerelease == 'true' }}

  build:
    runs-on: macos-latest
    needs: release
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.release.outputs.version }}
      - uses: oven-sh/setup-bun@v2
      - uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile
      - name: Set version in package.json
        env:
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          bun -e "
            const pkg = await Bun.file('package.json').json();
            pkg.version = process.env.VERSION;
            await Bun.write('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
      - name: Build Electrobun app
        run: bun run build
      - name: Package and upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          APP_DIR=$(find build -name "Klovi.app" -maxdepth 3 -type d | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "::error::Could not find Klovi.app in build/"
            exit 1
          fi
          ZIP_NAME="Klovi-${VERSION}-macos-arm64.zip"
          ditto -c -k --keepParent "$APP_DIR" "$ZIP_NAME"
          gh release upload "$VERSION" "$ZIP_NAME" --clobber

  update-cask:
    if: ${{ needs.release.outputs.prerelease != 'true' }}
    runs-on: ubuntu-latest
    needs:
      - release
      - build
    environment: homebrew
    steps:
      - name: Download release asset and update Homebrew cask
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ needs.release.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          set -e

          ZIP_NAME="Klovi-${VERSION}-macos-arm64.zip"
          curl -L -o "$ZIP_NAME" \
            "https://github.com/${REPO}/releases/download/${VERSION}/${ZIP_NAME}"

          SHA256=$(sha256sum "$ZIP_NAME" | cut -d' ' -f1)
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/cookielab/homebrew-tap.git"
          cd homebrew-tap

          # Remove old Formula if it exists
          rm -f Formula/klovi.rb

          mkdir -p Casks
          cat > Casks/klovi.rb << CASK
          cask "klovi" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "${BASE_URL}/${ZIP_NAME}"
            name "Klovi"
            desc "Native desktop app for browsing and presenting AI coding session history"
            homepage "https://github.com/${REPO}"

            depends_on arch: :arm64

            app "Klovi.app"

            zap trash: [
              "~/Library/Application Support/io.cookielab.klovi",
              "~/Library/Preferences/io.cookielab.klovi.plist",
              "~/Library/Caches/io.cookielab.klovi",
            ]
          end
          CASK

          # Remove leading whitespace from heredoc indentation
          sed -i 's/^          //' Casks/klovi.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update klovi cask to ${VERSION}"
          git push
