name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type (auto = detect from conventional commits)"
        required: true
        type: choice
        default: auto
        options:
          - auto
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine next version (auto)
        if: inputs.bump == 'auto'
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ github.token }}
          noVersionBumpBehavior: patch
          noNewCommitBehavior: patch

      - name: Determine next version (manual)
        if: inputs.bump != 'auto'
        id: manual
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          IFS='.' read -r major minor patch <<< "$TAG"
          case "${{ inputs.bump }}" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac
          echo "version=${major}.${minor}.${patch}" >> "$GITHUB_OUTPUT"

      - name: Create tag
        env:
          VERSION: ${{ inputs.bump == 'auto' && steps.semver.outputs.nextStrict || steps.manual.outputs.version }}
        run: |
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.bump == 'auto' && steps.semver.outputs.nextStrict || steps.manual.outputs.version }}
          generate_release_notes: true
